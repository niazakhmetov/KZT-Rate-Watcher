name: Обновление Курсов (CDI)

on:
  schedule:
    # Ежедневно в 07:00 по времени Казахстана (02:00 UTC)
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest

    # Разрешение на запись нужно для автокоммита
    permissions:
      contents: write

    steps:
      # 1. Клонирование репозитория
      - name: 1. Checkout repository
        uses: actions/checkout@v4

      # 2. Кэш pip (ускорение ×3)
      - name: 2. Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ hashFiles('requirements.txt') }}

      # 3. Настройка Python
      - name: 3. Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 4. Установка зависимостей
      - name: 4. Install dependencies
        run: pip install -r requirements.txt

      # 5. Запуск скрипта парсинга
      - name: 5. Run NBK parser script
        run: python src/parser_script.py

      # 6. Проверка, обновился ли файл
      - name: 6. Validate output
        run: |
          if git status --porcelain | grep -q "data/latest_rates.json"; then
            echo "✔ Файл обновлён, продолжаем."
          else
            echo "❌ Скрипт НЕ обновил data/latest_rates.json"
            exit 1
          fi

      # 7. Автоматический коммит и пуш
      - name: 7. Commit & push updated rates
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_user_name: KZT Rates Bot
          commit_user_email: actions-bot@github.com
          commit_message: "Automated: Update KZT exchange rates data"
          file_pattern: "data/latest_rates.json"
